<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">

	<!-- 주문 인서트 -->
	<insert id="insertOrder" parameterType="hashmap" useGeneratedKeys="true" keyProperty="ORDER_NO">
		<selectKey keyProperty="ORDER_NO" resultType="java.lang.Integer" order="BEFORE">
			SELECT ORDER_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		<![CDATA[
		INSERT INTO ORDER_3T
			(ORDER_NO,
		 	RECIPIENT_NAME,
		 	RECIPIENT_ZIPCODE,
		 	RECIPIENT_ADDR1,
		 	RECIPIENT_ADDR2,
		 	RECIPIENT_PHONE,
		 	REGDATE,
		 	TOTALPRICE,
		 	PAYMENT,
		 	DEPOSIT_NAME,
		 	DEPOSIT_BANK,
		 	MEMBER_ID
		 	) 
		VALUES
			(#{ORDER_NO},
			#{RECIPIENT_NAME},
			#{RECIPIENT_ZIPCODE},
			#{RECIPIENT_ADDR1},	
			#{RECIPIENT_ADDR2},
			#{RECIPIENT_PHONE},
			SYSDATE,
			#{TOTALPRICE},
			#{PAYMENT},
			#{DEPOSIT_NAME},
			#{DEPOSIT_BANK},
			#{MEMBER_ID}
			)
		]]>
		
		
	</insert>

	<insert id="insertOrderDetail" parameterType="hashmap" useGeneratedKeys="true" keyProperty="ORDER_DETAIL_NO">
		<selectKey keyProperty="ORDER_DETAIL_NO" resultType="java.lang.Integer" order="BEFORE">
			SELECT ORDER_DETAIL_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		<![CDATA[
		INSERT INTO ORDER_DETAIL
			(ORDER_DETAIL_NO,
		 	ORDER_NO,
		 	
		 	ATTRIBUTE_NO,
		 	GOODS_NO,
		 	
		 	COUNT
		 	)
		VALUES
			(#{ORDER_DETAIL_NO},
			#{ORDER_NO},
			
			#{ATTRIBUTE_NO},
			#{GOODS_NO},
			
			#{COUNT}
			
			)
			
		]]>
		
		
	</insert>

	<!-- 관리자 주문리스트 -->
 	<select id="selectOrderListAll" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		select
			REGDATE,
			ORDER_NO,
			STATE,
			MEMBER_ID,
			COUNT,
			ATTRIBUTE_NO,
			GOODS_NO,
			NAME,
			PRICE,
			SUBSTR(CONTENT, 0, 20) AS CONTENT,
			COLOR,
			GOODS_SIZE,
			WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  	(
		  	select 
		    	a.REGDATE,
		    	a.ORDER_NO,
			    a.STATE,
			    a.MEMBER_ID,
			    b.COUNT,
			    b.ATTRIBUTE_NO,
			    b.GOODS_NO,
			    c.NAME,
			    c.PRICE,
			    c.CONTENT,
			    d.color,
			    d.GOODS_SIZE,
			    e.sav_name
			from
		    	ORDER_3T a, ORDER_DETAIL b, GOODS c , GOODS_ATTRIBUTE d , UPLOAD e
		  	where
			    a.ORDER_NO=b.ORDER_NO AND
			    b.GOODS_NO=c.GOODS_NO AND
			    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
			    b.GOODS_NO=e.GOODS_NO AND
			    a.STATE IN (0,1,2,3)
		  	ORDER BY
		    	a.ORDER_NO desc
		    	)
		GROUP BY
			  REGDATE,
			  ORDER_NO,
			  STATE,
			  MEMBER_ID,
			  COUNT,
			  NAME,
			  ATTRIBUTE_NO,
			  GOODS_NO,
			  PRICE,
			  CONTENT,
			  COLOR,
			  GOODS_SIZE
	]]>
	</select>
	<!-- 관리자 교환리스트 -->
	<select id="selectChangeListAll" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		select
			REGDATE,
			ORDER_NO,
			STATE,
			MEMBER_ID,
			COUNT,
			ATTRIBUTE_NO,
			GOODS_NO,
			NAME,
			PRICE,
			SUBSTR(CONTENT, 0, 20) AS CONTENT,
			COLOR,
			GOODS_SIZE,
			WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  	(
		  	select 
		    	a.REGDATE,
		    	a.ORDER_NO,
			    a.STATE,
			    a.MEMBER_ID,
			    b.COUNT,
			    b.ATTRIBUTE_NO,
			    b.GOODS_NO,
			    c.NAME,
			    c.PRICE,
			    c.CONTENT,
			    d.color,
			    d.GOODS_SIZE,
			    e.sav_name
			from
		    	ORDER_3T a, ORDER_DETAIL b, GOODS c , GOODS_ATTRIBUTE d , UPLOAD e
		  	where
			    a.ORDER_NO=b.ORDER_NO AND
			    b.GOODS_NO=c.GOODS_NO AND
			    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
			    b.GOODS_NO=e.GOODS_NO AND
			    a.STATE IN (4,5,6,7)
		  	ORDER BY
		    	a.ORDER_NO desc
		    	)
		GROUP BY
			  REGDATE,
			  ORDER_NO,
			  STATE,
			  MEMBER_ID,
			  COUNT,
			  NAME,
			  ATTRIBUTE_NO,
			  GOODS_NO,
			  PRICE,
			  CONTENT,
			  COLOR,
			  GOODS_SIZE
	]]>
	</select>
	<!-- 관리자 환불리스트 -->
	<select id="selectRefundListAll" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		select
			REGDATE,
			ORDER_NO,
			STATE,
			MEMBER_ID,
			COUNT,
			ATTRIBUTE_NO,
			GOODS_NO,
			NAME,
			PRICE,
			SUBSTR(CONTENT, 0, 20) AS CONTENT,
			COLOR,
			GOODS_SIZE,
			WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  	(
		  	select 
		    	a.REGDATE,
		    	a.ORDER_NO,
			    a.STATE,
			    a.MEMBER_ID,
			    b.COUNT,
			    b.ATTRIBUTE_NO,
			    b.GOODS_NO,
			    c.NAME,
			    c.PRICE,
			    c.CONTENT,
			    d.color,
			    d.GOODS_SIZE,
			    e.sav_name
			from
		    	ORDER_3T a, ORDER_DETAIL b, GOODS c , GOODS_ATTRIBUTE d , UPLOAD e
		  	where
			    a.ORDER_NO=b.ORDER_NO AND
			    b.GOODS_NO=c.GOODS_NO AND
			    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
			    b.GOODS_NO=e.GOODS_NO AND
			    a.STATE IN (8,9)
		  	ORDER BY
		    	a.ORDER_NO desc
		    	)
		GROUP BY
			  REGDATE,
			  ORDER_NO,
			  STATE,
			  MEMBER_ID,
			  COUNT,
			  NAME,
			  ATTRIBUTE_NO,
			  GOODS_NO,
			  PRICE,
			  CONTENT,
			  COLOR,
			  GOODS_SIZE
	]]>
	</select>
	
	
	<select id="selectList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	
		select
		  REGDATE,
		  ORDER_NO,
    	  MEMBER_ID,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE,
		  WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  (select 
		    a.REGDATE,
		    a.ORDER_NO,
		    a.STATE,
        a.MEMBER_ID,
		    b.COUNT,
		    b.ATTRIBUTE_NO,
		    b.GOODS_NO,
		    c.PRICE,
		    c.CONTENT,
		    c.NAME,
		    d.color,
		    d.GOODS_SIZE,
		    e.sav_name
		  from
		    ORDER_3T a,ORDER_DETAIL b,GOODS c ,GOODS_ATTRIBUTE d, UPLOAD e
		  where
		    a.ORDER_NO=b.ORDER_NO AND
		    b.GOODS_NO=c.GOODS_NO AND
		    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
		    b.GOODS_NO=e.GOODS_NO AND
        	a.MEMBER_ID = #{MEMBER_ID}
		  ORDER BY
		    a.ORDER_NO desc)
		GROUP BY
      MEMBER_ID,
		  REGDATE,
		  ORDER_NO,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE
	
	]]>
	</select>
	
	<!-- 주문수리스트 -->
	<select id="orderList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	
		select
		  REGDATE,
		  ORDER_NO,
    	  MEMBER_ID,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE,
		  WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  (select 
		    a.REGDATE,
		    a.ORDER_NO,
		    a.STATE,
        a.MEMBER_ID,
		    b.COUNT,
		    b.ATTRIBUTE_NO,
		    b.GOODS_NO,
		    c.PRICE,
		    c.CONTENT,
		    c.NAME,
		    d.color,
		    d.GOODS_SIZE,
		    e.sav_name
		  from
		    ORDER_3T a,ORDER_DETAIL b,GOODS c ,GOODS_ATTRIBUTE d, UPLOAD e
		  where
		    a.ORDER_NO=b.ORDER_NO AND
		    b.GOODS_NO=c.GOODS_NO AND
		    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
		    b.GOODS_NO=e.GOODS_NO AND
        	a.MEMBER_ID = #{MEMBER_ID} AND
        	a.STATE IN (0,1,2,3)
		  ORDER BY
		    a.ORDER_NO desc)
		GROUP BY
      MEMBER_ID,
		  REGDATE,
		  ORDER_NO,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE
	
	]]>
	</select>
	
	<!-- 교환수 리스트 -->
	<select id="swapList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	
		select
		  REGDATE,
		  ORDER_NO,
    	  MEMBER_ID,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE,
		  WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  (select 
		    a.REGDATE,
		    a.ORDER_NO,
		    a.STATE,
        a.MEMBER_ID,
		    b.COUNT,
		    b.ATTRIBUTE_NO,
		    b.GOODS_NO,
		    c.PRICE,
		    c.CONTENT,
		    c.NAME,
		    d.color,
		    d.GOODS_SIZE,
		    e.sav_name
		  from
		    ORDER_3T a,ORDER_DETAIL b,GOODS c ,GOODS_ATTRIBUTE d, UPLOAD e
		  where
		    a.ORDER_NO=b.ORDER_NO AND
		    b.GOODS_NO=c.GOODS_NO AND
		    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
		    b.GOODS_NO=e.GOODS_NO AND
        	a.MEMBER_ID = #{MEMBER_ID} AND
        	a.STATE IN (4,5,6,7)
		  ORDER BY
		    a.ORDER_NO desc)
		GROUP BY
      MEMBER_ID,
		  REGDATE,
		  ORDER_NO,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE
	
	]]>
	</select>
	
	<!-- 환불수 리스트 -->
	<select id="refundList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	
		select
		  REGDATE,
		  ORDER_NO,
    	  MEMBER_ID,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE,
		  WM_CONCAT(SAV_NAME) AS IMAGE
		from
		  (select 
		    a.REGDATE,
		    a.ORDER_NO,
		    a.STATE,
        a.MEMBER_ID,
		    b.COUNT,
		    b.ATTRIBUTE_NO,
		    b.GOODS_NO,
		    c.PRICE,
		    c.CONTENT,
		    c.NAME,
		    d.color,
		    d.GOODS_SIZE,
		    e.sav_name
		  from
		    ORDER_3T a,ORDER_DETAIL b,GOODS c ,GOODS_ATTRIBUTE d, UPLOAD e
		  where
		    a.ORDER_NO=b.ORDER_NO AND
		    b.GOODS_NO=c.GOODS_NO AND
		    b.ATTRIBUTE_NO=d.ATTRIBUTE_NO AND
		    b.GOODS_NO=e.GOODS_NO AND
        	a.MEMBER_ID = #{MEMBER_ID} AND
        	a.STATE IN (8,9)
		  ORDER BY
		    a.ORDER_NO desc)
		GROUP BY
      MEMBER_ID,
		  REGDATE,
		  ORDER_NO,
		  STATE,
		  COUNT,
		  NAME,
		  ATTRIBUTE_NO,
		  GOODS_NO,
		  PRICE,
		  CONTENT,
		  COLOR,
		  GOODS_SIZE
	
	]]>
	</select>
	
	
 	<select id="selectSale" parameterType="hashmap" resultType="map">
	<![CDATA[
		SELECT
			to_char(REGDATE,'YYYY-MM-DD') as REGDATE,
			SUM(TOTALPRICE) as TOTAL
		FROM
			ORDER_3T
		WHERE
			STATE =3
		GROUP BY
			to_char(REGDATE,'YYYY-MM-DD')
		ORDER BY
			REGDATE
	]]>
	</select>
	
	<select id="selectSearchSale" parameterType="hashmap" resultType="map">
	<![CDATA[
		SELECT
			to_char(REGDATE,'YYYY-MM-DD') as REGDATE,
			SUM(TOTALPRICE) as TOTAL
		FROM
			ORDER_3T
		WHERE
			STATE =3 AND
			REGDATE BETWEEN to_date(#{start},'YYYY-MM-DD') AND to_date(#{end},'YYYY-MM-DD')
		GROUP BY
			to_char(REGDATE,'YYYY-MM-DD')
		ORDER BY
			REGDATE
	]]>
	</select>
	
	
	<update id="changeState1" parameterType="hashmap">
		
			UPDATE 
				order_3t 
			SET
				state = state+1
				<if test='STATE.equals("2")'>
					,REGDATE=SYSDATE
				</if>
			WHERE
				ORDER_NO = #{ORDER_NO}	
	</update>

	<update id="changeState2" parameterType="hashmap">
		
			UPDATE 
				order_3t 
			SET
				state = state-1
			WHERE
				ORDER_NO = #{ORDER_NO}	
		
	</update>
	
	<update id="changeState8" parameterType="hashmap">
		
			UPDATE 
				order_3t 
			SET
				state = 8
			WHERE
				ORDER_NO = #{ORDER_NO}	
		
	</update>
	
	<update id="changeState9" parameterType="hashmap">
		
			UPDATE 
				order_3t 
			SET
				state = 9
			WHERE
				ORDER_NO = #{ORDER_NO}	
		
	</update>
	
	
</mapper>