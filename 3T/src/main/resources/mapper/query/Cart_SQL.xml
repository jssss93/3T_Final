<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cart">

	<!-- 장바구니 신청전에 똑같은 카인드넘버있나 확인 -->
	<select id="confirmCart" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
		SELECT * FROM CART
		WHERE GOODS_KIND_NUMBER=#{GOODS_KIND_NUMBER} AND MEMBER_NUMBER=#{MEMBER_NUMBER}
	]]>
	</select>

	<!-- 회원 장바구니 인서트 -->
	<insert id="insertCart" useGeneratedKeys="true" keyProperty="CART_NO">
		<selectKey keyProperty="CART_NO" resultType="java.lang.Integer" order="BEFORE">
			SELECT CART_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		<![CDATA[
			INSERT INTO CART 
				( 
					CART_NO,
					MEMBER_ID,
					REGDATE
			 	)
			 VALUES 
			 	( 
					#{CART_NO},
					#{MEMBER_ID},
					#{REGDATE}
				)
		]]>
	</insert>
	
	<insert id="insertCartDetail" useGeneratedKeys="true" keyProperty="CART_DETAIL_NO">
		<selectKey keyProperty="CART_DETAIL_NO" resultType="java.lang.Integer" order="BEFORE">
			SELECT CART_DETAIL_NO_SEQ.NEXTVAL FROM DUAL
		</selectKey>
		<![CDATA[
			INSERT INTO CART_DETAIL 
				( 
					CART_DETAIL_NO,
					CART_NO,
					ATTRIBUTE_NO,
					GOODS_NO,
					COUNT
			 	)
			 VALUES 
			 	( 
					#{CART_DETAIL_NO},
					#{CART_NO},
					#{ATTRIBUTE_NO},
					#{GOODS_NO},
					#{COUNT}
				)
		]]>
	</insert>

	<!-- 회원 장바구니 조회  on되어있는 상품만 등록시간이 3일 이하인 상품만-->
	<select id="selectMyCart" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT A.GOODS_NUMBER, A.CART_NUMBER, A.MEMBER_NUMBER,
			A.CART_REG_DATE, A.CART_AMOUNT, A.GOODS_KIND_NUMBER, E.GOODS_AMOUNT,
			E.GOODS_SIZE, E.GOODS_COLOR, E.GOODS_KIND_NUMBER,
			D.GOODS_NAME, D.GOODS_PRICE, D.GOODS_DISPRICE, D.GOODS_SALEDATE,
			D.GOODS_THUMBNAIL,D.GOODS_CATEGORY1, D.GOODS_CATEGORY2
			FROM CART A, GOODS D, GOODS_KIND E WHERE A.MEMBER_NUMBER=${MEMBER_NUMBER}
		    AND A.CART_REG_DATE>SYSDATE-3
        	AND A.GOODS_KIND_NUMBER=E.GOODS_KIND_NUMBER
			AND A.GOODS_NUMBER=D.GOODS_NUMBER AND D.GOODS_ONOFF=0
			ORDER BY A.CART_REG_DATE DESC, A.GOODS_NUMBER ASC
		]]>
	</select>

	<!-- 세션에서 장바구니 목록 불러오기(비회원 인서트는 SESSION에 저장하고
	비회원 장바구니 조회는 SESSION에서 GOODS_NUMBER, GOODS_KINDSNUMBER,  CART_AMOUNT 를 가지고 셀렉트문 실행) -->
	<select id="sessionCartList" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
			SELECT A.GOODS_NAME, A.GOODS_PRICE, A.GOODS_DISPRICE, A.GOODS_THUMBNAIL,
			A.GOODS_CATEGORY1, A.GOODS_CATEGORY2, A.GOODS_SALEDATE, A.GOODS_NUMBER,
			C.GOODS_AMOUNT, C.GOODS_SIZE, C.GOODS_COLOR, C.GOODS_KIND_NUMBER
			FROM GOODS A, GOODS_KIND C
			WHERE A.GOODS_NUMBER= #{GOODS_NUMBER} AND C.GOODS_KIND_NUMBER=#{GOODS_KIND_NUMBER}
			AND A.GOODS_ONOFF=0
	]]>
	</select>


	<!-- 장바구니 수량수정하기전 수정폼에 띄어줄 셀렉트문[옵션변경] -->
	<!-- 회원 -->
	<select id="selectOption" parameterType="hashmap" resultType="hashmap">	
		<![CDATA[
			SELECT A.CART_NUMBER, A.GOODS_NUMBER, A.GOODS_KIND_NUMBER, A.CART_AMOUNT,
			C.GOODS_NAME, C.GOODS_PRICE, C.GOODS_DISPRICE, C.GOODS_THUMBNAIL, C.GOODS_SALEDATE,
			D.GOODS_SIZE, D.GOODS_AMOUNT, D.GOODS_COLOR
			FROM CART A, GOODS C, GOODS_KIND D
			WHERE A.GOODS_NUMBER=C.GOODS_NUMBER AND A.GOODS_KIND_NUMBER=D.GOODS_KIND_NUMBER
			AND CART_NUMBER=#{CART_NUMBER}
		]]>
	</select>
	
	<!-- 비회원 -->
	<select id="sessionOption" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT C.GOODS_NUMBER, D.GOODS_KIND_NUMBER,
			C.GOODS_NAME, C.GOODS_PRICE, C.GOODS_DISPRICE, C.GOODS_THUMBNAIL,
			D.GOODS_SIZE, D.GOODS_AMOUNT, D.GOODS_COLOR, C.GOODS_SALEDATE
			FROM GOODS C, GOODS_KIND D
			WHERE C.GOODS_NUMBER=D.GOODS_NUMBER                      
			AND D.GOODS_KIND_NUMBER=#{GOODS_KIND_NUMBER}
		]]>
	</select>
	 
	<!-- 장바구니 수량 수정 (비회원은 SESSION값 REMOVE 후 다시 PUT) -->
	<update id="updateCarts" parameterType="hashmap">
		<![CDATA[
			UPDATE CART SET CART_AMOUNT=#{CART_AMOUNT}, CART_REG_DATE=SYSDATE
			WHERE CART_NUMBER=#{CART_NUMBER}
		]]>
	</update>

	<!-- 장바구니 삭제 -->

	<!-- 멤버 로그인시 3일지난거 자동삭제 -->
	<delete id="deleteCarts" parameterType="hashmap">
		<![CDATA[
			DELETE FROM CART WHERE CART_REG_DATE<SYSDATE-3 AND MEMBER_NUMBER= #{MEMBER_NUMBER}
		]]>
	</delete>

	<!-- 멤버가 직접삭제 -->
	<delete id="deleteMyCart" parameterType="hashmap">
		<![CDATA[
			DELETE FROM CART WHERE MEMBER_NUMBER=#{MEMBER_NUMBER} AND GOODS_KIND_NUMBER = #{GOODS_KIND_NUMBER}
		]]>
	</delete>

	<!-- 장바구니에서 주문 -->
	<!-- 회원 GOODS_KIND_NUMBER에 해당하는 장바구니만 뽑아온 후 나머지는 기존 구매와 동일처리 -->
	<select id="buyInCart" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT DISTINCT A.GOODS_NUMBER, A.CART_NUMBER, A.MEMBER_NUMBER,
			A.CART_REG_DATE, A.CART_AMOUNT, A.GOODS_KIND_NUMBER, E.GOODS_AMOUNT,
			E.GOODS_SIZE, E.GOODS_COLOR, E.GOODS_KIND_NUMBER,
			D.GOODS_NAME, D.GOODS_PRICE, D.GOODS_DISPRICE, D.GOODS_SALEDATE,
			D.GOODS_THUMBNAIL,D.GOODS_CATEGORY1, D.GOODS_CATEGORY2
			FROM CART A, GOODS D, GOODS_KIND E WHERE A.MEMBER_NUMBER=${MEMBER_NUMBER}
		    AND A.CART_REG_DATE>SYSDATE-3
        	AND A.GOODS_KIND_NUMBER=E.GOODS_KIND_NUMBER
        	AND A.GOODS_KIND_NUMBER=${GOODS_KIND_NUMBER}
			AND A.GOODS_NUMBER=D.GOODS_NUMBER AND D.GOODS_ONOFF=0
			ORDER BY A.CART_REG_DATE DESC, A.GOODS_NUMBER ASC
		]]>
	</select>
	<!-- 비회원은 세션에 GOODS_KIND_NUMBER가 이미 존재한상태에서 
	장바구니에서 일부 품목만 선택했을때 새로운 GOODS_KIND_NUMBER2 를 세션에 저장해서 
	그 값을 위에 비회원 장바구니 조회 쿼리에 적용 후 기존 비회원 구매와 동일처리 -->

</mapper>